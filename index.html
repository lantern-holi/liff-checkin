<!-- 送出按鈕事件：組合訊息並透過 LIFF 發送 -->
<script>
  document.getElementById("submitBtn").addEventListener("click", async () => {
    if (!liff.isInClient()) {
      alert("請在 LINE App 中使用此功能！");
      return;
    }
    const context = liff.getContext();
    if (!context || (!context.userId && !context.utouId)) {
      alert("目前無有效聊天上下文，請從個人對話中使用此功能。");
      return;
    }
    
    const systolic = getPickerValue("picker-systolic", 90);
    const diastolic = getPickerValue("picker-diastolic", 60);
    const heartRate = getPickerValue("picker-heartRate", 40);
    
    // 取得當下日期並轉換為民國年格式
    const now = new Date();
    const rocYear = now.getFullYear() - 1911;
    const month = (now.getMonth() + 1).toString().padStart(2, "0");
    const day = now.getDate().toString().padStart(2, "0");
    const recordDate = `${rocYear}-${month}-${day}`;
    
    // 取得目前時間(24H制)的時與分
    const hours = now.getHours().toString().padStart(2, "0");
    const minutes = now.getMinutes().toString().padStart(2, "0");
    const measureTime = `${hours}:${minutes}`;
    
    // 組合最終訊息內容
    const messageText = `血壓紀錄為${systolic}/${diastolic}/${heartRate}\n登錄日期${recordDate}\n量測時間${measureTime}`;
    
    try {
      await liff.sendMessages([{ type: "text", text: messageText }]);
      document.getElementById("result").textContent = "訊息已送出！";
      liff.closeWindow();
    } catch (error) {
      console.error("訊息送出失敗：", error);
      document.getElementById("result").textContent = "訊息送出失敗，請稍後再試。";
    }
  });
</script>
